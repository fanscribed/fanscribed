{% extends "base.html" %}
{% load staticfiles %}

{% block nav_class_transcribe %}
  active
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'vendor/soundmanagerv297a-20131201/css/page-player.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendor/soundmanagerv297a-20131201/css/flashblock.css' %}"/>
{% endblock %}

{% block extra_js %}
  {% if DEBUG %}
    <script type="text/javascript" src="{% static 'vendor/soundmanagerv297a-20131201/script/soundmanager2.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/jquery.hotkeys/jquery.hotkeys.js' %}"></script>
  {% else %}
    <script type="text/javascript" src="{% static 'vendor/soundmanagerv297a-20131201/script/soundmanager2-nodebug-jsmin.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/jquery.hotkeys/jquery.hotkeys.js' %}"></script>
  {% endif %}

  <script>

    soundManager.setup({
      {% if DEBUG %}debugMode: true,{% endif %}
      // preferFlash: false
      flashVersion: 9,
      preferFlash: true, // for visualization effects
      useHighPerformance: true, // keep flash on screen, boost performance
      wmode: 'transparent', // transparent SWF, if possible

      {# Don't use static tag; we do NOT want to load this from S3, otherwise request signing gets in the way #}
      url: '/static/vendor/soundmanagerv297a-20131201/swf/'
    });

    // custom page player configuration

    var PP_CONFIG = {
      autoStart: true,      // begin playing first sound when page loads
      playNext: false,        // stop after one sound, or play through list until end
      useThrottling: false,  // try to rate-limit potentially-expensive calls (eg. dragging position around)</span>
      usePeakData: false,     // [Flash 9 only] whether or not to show peak data (left/right channel values) - nor noticable on CPU
      useWaveformData: false,// [Flash 9 only] show raw waveform data - WARNING: LIKELY VERY CPU-HEAVY
      useEQData: false,      // [Flash 9 only] show EQ (frequency spectrum) data
      useFavIcon: false     // try to apply peakData to address bar (Firefox + Opera) - performance note: appears to make Firefox 3 do some temporary, heavy disk access/swapping/garbage collection at first(?) - may be too heavy on CPU
    }

  </script>
  <script type="text/javascript" src="{% static 'vendor/soundmanagerv297a-20131201/script/page-player.js' %}"></script>

  <script type="text/javascript">

    {# TODO: clean this up #}

    $(function () {
      var isPlaying = function (sound) {
        return (sound.playState == 1 && !sound.paused);
      };

      var playOrPauseAudio = function () {
        var sound = pagePlayer.sounds[0];

        if (!isPlaying(sound)) {

          console.log('currently stopped or paused; now playing');
          // rewind by .75 seconds
          var newPosition = Math.max(0, sound.position - 750);
          sound.setPosition(newPosition);
          sound.play();

        } else {

          console.log('currently playing; now pausing');
          sound.pause();

        }

        return false;
      };

      var rewindAudio = function () {
        var sound = pagePlayer.sounds[0];

        // rewind by 2 seconds
        var newPosition = Math.max(0, sound.position - 2000);
        sound.setPosition(newPosition);

        // play if not already playing
        if (!isPlaying(sound)) {
          sound.play();
        }

        return false;
      };

      var restartAudio = function () {
        var sound = pagePlayer.sounds[0];

        sound.setPosition(0);

        if (!isPlaying(sound)) {
          sound.play();
        }

        return false;
      };

      var saveAndContinue = function () {
        $('button[name="continue"]').click();
      };

      var saveAndExit = function () {
        $('button[name="exit"]').click();
      };

      var cancelAndExit = function () {
        $('button[name="cancel"]').click();
      };

      {# TODO: support other keyboard layouts #}

      var bindTaskHotkeys = function (e) {
        var $e = $(e);
        $e.bind('keydown', '\\', playOrPauseAudio);
        $e.bind('keydown', '`', rewindAudio);
        $e.bind('keydown', 'shift+`', restartAudio);
        $e.bind('keydown', 'ctrl+s', saveAndContinue);
        $e.bind('keydown', 'ctrl+shift+s', saveAndExit);
        $e.bind('keydown', 'ctrl+esc', cancelAndExit);
      };

      bindTaskHotkeys($('body'));
      bindTaskHotkeys($('input'));
      bindTaskHotkeys($('textarea'));
    });

  </script>

{% endblock %}

{% block content %}

  <h1><a href="{% url 'transcripts:detail' pk=task.transcript.pk %}">{{ task.transcript }}</a></h1>

  <div id="sm2-container">
   <!-- SM2 flash goes here -->
  </div>

  <div class="row">
    <div class="col-md-4">
      {% block task_info %}
      {% endblock %}
    </div>
    <div class="col-md-8">
      {% include "transcripts/_task_detail_audio.html" %}
      {% block task_workarea %}
      {% endblock %}
    </div>
  </div>

{% endblock %}
