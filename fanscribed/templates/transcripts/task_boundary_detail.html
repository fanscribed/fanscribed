{% extends "transcripts/task_base.html" %}
{% load bootstrap3 %}


{% block title %}
  {% if not task.is_review %}Boundary{% else %}Review Boundary{% endif %}
{% endblock %}


{% block extra_js %}
  {{ block.super }}

  <script type="text/javascript">

    $(function () {

      $('#id_start').focus();

      var offset = {{ task.start }};

      var updatePosition = function () {
        var actualPosition = taskSound.position / 1000 + offset;
        $('#playing-current').text(actualPosition.toFixed(2));
      };

      var prepareTaskSoundPositionTracking = function () {
        // Shim the callbacks onto the sound, so page-player calls them
        // along with normal behavior.
        {# TODO: clean this up #}
        taskSound.whileplaying_shim = updatePosition;
      };

      soundManager.onready(prepareTaskSoundPositionTracking);

      // Bind Ctrl+R to reload the audio.
      var reloadAudio = function () {
        var start = Math.max(0, parseFloat($('#id_start').val()));
        var end = parseFloat($('#id_end').val());
        var url = "{% url 'transcripts:task_audio' transcript_pk=task.transcript.id type=task.TASK_TYPE pk=task.id %}?start=" + start + '&end=' + end;

        // Regenerate and reinitialize the pagePlayer system.
        delete taskSound.onplay_shim;
        delete taskSound.onresume_shim;
        delete taskSound.onstop_shim;
        delete taskSound.onpause_shim;
        delete taskSound.onfinish_shim;
        delete taskSound.whileplaying_shim;
        offset = start;
        var $playlist = $('ul.playlist');
        $playlist.empty().append('<li><a/></li>');
        $playlist.find('a').attr('href', url).addClass('playable').text('Task Audio');
        pagePlayer.init(PP_CONFIG);
        window.prepareTaskSound();
        prepareTaskSoundPositionTracking();
        showPlaying();

        // Update the visible start/end next to the player.
        $('#playing-start').text(start);
        $('#playing-end').text(end);

        return false;
      };
      
      var bindReloadHotkeys = function (e) {
        var $e = $(e);
        $e.bind('keydown', 'ctrl+r', reloadAudio);
      };

      bindReloadHotkeys($('body'));
      bindReloadHotkeys($('input'));
      bindReloadHotkeys($('textarea'));

    });

  </script>
{% endblock %}


{% block task_info %}

  <h2>{% if not task.is_review %}Boundary{% else %}Review Boundary{% endif %}</h2>

  {% if user.is_staff and 'details' in request.GET %}
    <dl class="dl-horizontal">
      {% include "transcripts/_task_detail_common.html" %}
    </dl>
  {% endif %}

  <div class="well">{% include "transcripts/_guidelines_boundary.html" %}</div>

{% endblock %}


{% block task_audio %}
  {% include "transcripts/_task_detail_audio.html" with reload=True %}
{% endblock %}


{% block task_workarea %}

  {% if task.state == 'presented' %}

    <div class="well">
      <p style="font-size:20px"><strong>{{ task.sentence.latest_text }}</strong></p>
    </div>

    <form action="" method="post" class="form">
      {% csrf_token %}
      {% bootstrap_form form %}
      {% include "transcripts/_task_buttons.html" %}
    </form>

  {% else %}

    <h3>Boundary</h3>

    <dt>Start</dt>
    <dd>{{ task.start }}</dd>

    <dt>End</dt>
    <dd>{{ task.end }}</dd>

  {% endif %}

{% endblock %}
